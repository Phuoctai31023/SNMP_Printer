<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Chi tiết Bộ Phận - <%= department.name %></title>

    <!-- Bootstrap & Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Roboto", sans-serif;
        background-color: #f8f9fa;
      }
      .card-header {
        font-weight: 500;
      }
      .badge {
        font-size: 0.75rem;
      }
      .offcanvas {
        width: 280px;
      }
      .list-group-item.active {
        background-color: #0d6efd !important;
        color: #fff !important;
        font-weight: 500;
      }
      /* Floating button */
      .floating-btn {
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 2000;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }
    </style>
  </head>
  <body>
    <div class="container-fluid mt-4">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="text-primary mb-0">
          <i class="bi bi-building-gear me-2"></i> <%= department.name %>
        </h3>
        <a href="/departments" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left"></i> Quay lại
        </a>
      </div>

      <!-- Offcanvas -->
      <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasDept">
        <div class="offcanvas-header">
          <h5 class="offcanvas-title">
            <i class="bi bi-building"></i> Bộ phận
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="offcanvas"
          ></button>
        </div>
        <div class="offcanvas-body p-0">
          <div class="list-group list-group-flush">
            <% departments.forEach(d => { %>
            <a
              href="/departments/<%= d._id %>"
              class="list-group-item list-group-item-action <%= d._id.toString() === department._id.toString() ? 'active' : '' %>"
            >
              <i class="bi bi-diagram-3 me-2"></i> <%= d.name %>
            </a>
            <% }) %>
          </div>
        </div>
      </div>

      <!-- Mô tả -->
      <% if (department.description) { %>
      <div class="card mb-4 shadow-sm">
        <div class="card-body">
          <p class="mb-0 text-muted">
            <i class="bi bi-info-circle"></i> <%= department.description %>
          </p>
        </div>
      </div>
      <% } %>

      <!-- Hai bảng -->
      <div class="row g-4">
        <!-- Users -->
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-header bg-dark text-white">
              <i class="bi bi-people"></i> Người dùng (<%= users.length %>)
            </div>
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Quyền</th>
                    <th>Trạng thái</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (users.length) { users.forEach(u => { %>
                  <tr>
                    <td><%= u.username %></td>
                    <td><%= u.email || '-' %></td>
                    <td>
                      <span
                        class="badge <%= u.role === 'admin' ? 'bg-primary' : 'bg-info text-dark' %>"
                      >
                        <%= u.role %>
                      </span>
                    </td>
                    <td>
                      <span
                        class="badge <%= u.isBlocked ? 'bg-danger' : 'bg-success' %>"
                      >
                        <%= u.isBlocked ? 'Đã chặn' : 'Hoạt động' %>
                      </span>
                    </td>
                  </tr>
                  <% }) } else { %>
                  <tr>
                    <td colspan="4" class="text-center text-muted">
                      Không có user
                    </td>
                  </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Printers -->
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-header bg-dark text-white">
              <i class="bi bi-printer"></i> Máy in (<%= printers.length %>)
            </div>
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>IP</th>
                    <th>Loại</th>
                    <th>Serial</th>
                    <th>Trạng thái</th>
                    <th>Tình trạng</th>
                    <th>Toner</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (printers.length) { printers.forEach(p => { %>
                  <tr>
                    <td><%= p.ip_address %></td>
                    <td>
                      <%= (p.printer_type || p.model || p.type || p.vendor ||
                      '-') %>
                    </td>
                    <td><%= p.serial_number || '-' %></td>
                    <td>
                      <span
                        class="badge <%= p.online ? 'bg-success' : 'bg-secondary' %>"
                      >
                        <%= p.online ? 'Online' : 'Offline' %>
                      </span>
                    </td>
                    <td>
                      <span class="badge bg-warning text-dark">
                        <%= (p.condition && p.condition !== '' ? p.condition :
                        (p.online ? 'Online' : 'Offline')) %>
                      </span>
                    </td>
                    <td>
                      <% let tonerStr = '-'; if (p.toner_level !== undefined &&
                      p.toner_level !== null) { tonerStr = typeof p.toner_level
                      === 'string' ? p.toner_level : String(p.toner_level) +
                      '%'; } %> <%= tonerStr %>
                    </td>
                  </tr>
                  <% }) } else { %>
                  <tr>
                    <td colspan="6" class="text-center text-muted">
                      Không có máy in
                    </td>
                  </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Floating Button -->
    <button
      class="btn btn-primary floating-btn"
      data-bs-toggle="offcanvas"
      data-bs-target="#offcanvasDept"
      data-bs-toggle="tooltip"
      title="Danh sách bộ phận"
    >
      <i class="bi bi-list"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Kích hoạt tooltip
      var tooltipTriggerList = [].slice.call(
        document.querySelectorAll('[data-bs-toggle="tooltip"]')
      );
      tooltipTriggerList.map(function (el) {
        return new bootstrap.Tooltip(el);
      });
    </script>
  </body>
</html>
